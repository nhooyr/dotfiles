#!/usr/bin/env bash

set -euo pipefail

if [[ "$OSTYPE" == darwin* ]]; then
	subl -wn "$@"
	exit 0
fi

ssh ien osascript <<EOF
tell application "Sublime Text" to activate
EOF
focusTerminal() {
	ssh ien osascript <<EOF
tell application "Terminal" to activate
EOF
}

if [[ $# -eq 0 ]]; then
	ssh ien subl -wn
	focusTerminal
	exit 0
fi

if [[ $1 == -- ]]; then
	shift
fi

path="$(readlink -m "$*")"
if [[ -d $path ]]; then
	echo "can only open regular files"
	exit 1
fi
tempPath="$(ssh ien mktemp -d)"
ssh ien sshfs -o allow_other,default_permissions "dev.coder.com:$(dirname "$path")" "$tempPath" 
ssh ien subl -wn "${tempPath}/$(basename "$path")"
focusTerminal
ssh ien umount -f "$tempPath"
