#!/usr/bin/env bash

set -euo pipefail

sublFlags="-wn"

if [[ $OSTYPE == darwin* ]]; then
  subl "$sublFlags" "$@"
  exit 0
fi

ssh ien osascript << EOF
tell application "Sublime Text" to activate
EOF
cleanup() {
  ssh ien osascript << EOF
tell application "Terminal" to activate
EOF
}

trap cleanup EXIT

if [[ $# -eq 0 ]]; then
  ssh ien subl "$sublFlags"
  exit 0
fi

# Some commands expect this to be ignored.
if [[ $1 == -- ]]; then
  shift
fi

# Only for persistent invocations is it safe to not scp back.
if ! [[ -e "$*" ]]; then
  touch "$*"
fi
realPath="$(realpath "$*")"
if [[ $realPath == ~/src/nhooyr* ]]; then
  ssh ien subl "$sublFlags" "${realPath/$HOME//Users/nhooyr}"
  exit 0
fi

tempFile="$(ssh ien mktemp -d)/$(basename "$*")"
scp -q "$*" "ien:${tempFile}"
ssh ien subl "$sublFlags" "$tempFile"

if ! [[ ${EDITOR_READONLY-} ]]; then
  scp -q "ien:${tempFile}" "$*"
fi
