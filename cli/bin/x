#!/usr/bin/env bash

set -euo pipefail

if ! ls ~/.ssh/sockets/*-$remote &> /dev/null; then
  status="$(gcloud --configuration=nhooyr-coder compute instances describe --zone=us-central1-a "$remote" --format=json | jq -r .status)"
  if [[ $status != "RUNNING" ]]; then
    echo "$remote: $status"
    gcloud --configuration=nhooyr-coder compute instances start --zone=us-central1-a "$remote"
  fi
fi

if [[ $# -gt 0 ]]; then
  argv="-c '$*'"
fi
ssh -t "$remote" "cd $(xpath) 2> /dev/null; \$SHELL -l ${argv-}"
