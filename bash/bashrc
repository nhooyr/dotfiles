#!/usr/bin/env bash

set -o pipefail

tabs -4

BASHRC_DIR="$(dirname "$(realpath "$BASH_SOURCE")")"

source "${BASHRC_DIR}/prompt"

export BASH_COMPLETION_COMPAT_DIR="/usr/local/etc/bash_completion.d"
[[ -r "/usr/local/etc/profile.d/bash_completion.sh" ]] && . "/usr/local/etc/profile.d/bash_completion.sh"

add_path() {
	if [[ $PATH != *${1}:* ]]; then
		PATH="${1}:${PATH}"
	fi
}

# Reset LS_COLORS first.
LS_COLORS='rs=00:di=00:ln=00:mh=00:pi=00:so=00:do=00:bd=00:cd=00:or=00:mi=00:su=00:sg=00:ca=00:tw=00:ow=00:st=00:ex=00:*.tar=00:*.tgz=00:*.arc=00:*.arj=00:*.taz=00:*.lha=00:*.lz4=00:*.lzh=00:*.lzma=00:*.tlz=00:*.txz=00:*.tzo=00:*.t7z=00:*.zip=00:*.z=00:*.dz=00:*.gz=00:*.lrz=00:*.lz=00:*.lzo=00:*.xz=00:*.zst=00:*.tzst=00:*.bz2=00:*.bz=00:*.tbz=00:*.tbz2=00:*.tz=00:*.deb=00:*.rpm=00:*.jar=00:*.war=00:*.ear=00:*.sar=00:*.rar=00:*.alz=00:*.ace=00:*.zoo=00:*.cpio=00:*.7z=00:*.rz=00:*.cab=00:*.wim=00:*.swm=00:*.dwm=00:*.esd=00:*.jpg=00:*.jpeg=00:*.mjpg=00:*.mjpeg=00:*.gif=00:*.bmp=00:*.pbm=00:*.pgm=00:*.ppm=00:*.tga=00:*.xbm=00:*.xpm=00:*.tif=00:*.tiff=00:*.png=00:*.svg=00:*.svgz=00:*.mng=00:*.pcx=00:*.mov=00:*.mpg=00:*.mpeg=00:*.m2v=00:*.mkv=00:*.webm=00:*.ogm=00:*.mp4=00:*.m4v=00:*.mp4v=00:*.vob=00:*.qt=00:*.nuv=00:*.wmv=00:*.asf=00:*.rm=00:*.rmvb=00:*.flc=00:*.avi=00:*.fli=00:*.flv=00:*.gl=00:*.dl=00:*.xcf=00:*.xwd=00:*.yuv=00:*.cgm=00:*.emf=00:*.ogv=00:*.ogx=00:*.aac=00:*.au=00:*.flac=00:*.m4a=00:*.mid=00:*.midi=00:*.mka=00:*.mp3=00:*.mpc=00:*.ogg=00:*.ra=00:*.wav=00:*.oga=00:*.opus=00:*.spx=00:*.xspf=00:'
export LS_COLORS="$LS_COLORS:di=34:ln=35:so=32:pi=32:ex=31;01"

IGNOREEOF=1

GLOBIGNORE=".:.."
HISTSIZE=10000

export EDITOR=editor
export MANWIDTH=80
export PAGER='ansifilter | pager'
export GOPATH=~/.local/share/gopath
add_path /usr/local/opt/ruby/
add_path /usr/local/lib/ruby/gems/2.6.0/bin
add_path "${GOPATH}/bin"
add_path ~/bin

alias sudo='sudo '

# Occasionally random things give me errors because the default limit is so low.
ulimit -n 8192

ls() {
	gls --indicator-style=classify --color=auto "$@"
}

alias r="source ~/.bashrc"
alias s="subl -n"
alias gol="goland"

alias l="ls -lh"
alias ll="ls -lhA"
alias e="editor"
alias ec="e ${BASH_SOURCE}"

source /usr/local/Caskroom/google-cloud-sdk/latest/google-cloud-sdk/path.bash.inc
source /usr/local/Caskroom/google-cloud-sdk/latest/google-cloud-sdk/completion.bash.inc

# Avoid duplicates
HISTCONTROL=ignoredups:erasedups
shopt -s histappend
shopt -s autocd
shopt -s checkhash
shopt -s checkjobs
shopt -s direxpand # https://bugs.launchpad.net/ubuntu/+source/bash/+bug/778627
shopt -s dotglob
shopt -s extglob
shopt -s globstar
shopt -s histreedit
shopt -s lithist
shopt -s nocaseglob
shopt -s nocasematch

alias grep="grep --color"

# https://superuser.com/questions/1067801/ctrlr-in-shell-if-i-go-past-the-command-i-want-how-do-i-get-back-to-it
stty -ixon

bind '"\ee"':shell-expand-line

cd() {
	if [[ $# == 0 ]]; then
		pushd ~ > /dev/null
		return
	fi
	pushd "$@" > /dev/null
}

pd() {
	popd "$@" > /dev/null
}

alias d=cd

mcd() {
	mkdir -p "$@"
	cd "$@"
}

gcd() {
	cd "$(git rev-parse --show-cdup)"
}

add_cdpath() {
	if [[ ! $CDPATH ]]; then
		CDPATH=$1
		return
	fi

	if [[ $CDPATH != *${1}:* ]]; then
		CDPATH="${CDPATH}:${1}"
	fi
}

add_cdpath ~/projects
add_cdpath ~/github
add_cdpath ~/coder
add_cdpath ~/play
add_cdpath ~/github/nhooyr
add_cdpath ~/github/cdr
add_cdpath ~/github/codercom
add_cdpath ~/github/Microsoft
add_cdpath ~/play
add_cdpath ~/bin

bind '"\er":"\C-a\C-r\C-y\C-r"'

alias gs="git status"
alias g="git"
alias gi="git init"
alias ga="git add"
alias gcm="git commit -v"
alias gcma="git commit -v --amend"
alias gcmf="git commit -v --fixup"
alias gb="git branch"
alias grb="git rebase"
alias gps="git push"
alias gpf="git push --force"
alias gd="git diff"
alias gdc="git diff --cached"
alias gl="git log"
alias gpr="git pull-request"
alias gcl="git clone"
alias gpl="git pull"
alias gch="git checkout"

alias md="mkdir -p"
alias gh="github"
alias pc="pbcopy"
alias pp="pbpaste"
alias up="cd .."
alias vim="nvim"
alias y="yarn"
alias npm="echo use yarn"

alias bu='brew update && brew upgrade && brew cask upgrade'

github() {
	local branch
	branch=$(git rev-parse --abbrev-ref HEAD)
	if [[ ! $branch ]]; then
		return
	fi

	local url
	url=$(hub pr list -f "%U%n" -h fixes)

	# First URL in case multiple PR's use the same branch.
	url=${url[0]}

	if [[ ! $url ]]; then
		url=$(hub browse -u)
	fi

	python -mwebbrowser "$url" > /dev/null
}

alias icloud="cd ~/Library/Mobile\ Documents/com~apple~CloudDocs"
